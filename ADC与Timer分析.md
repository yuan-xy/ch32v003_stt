## ADC与Timer分析

### ADC
#### （1）`RCC->CFGR0 &= ~(0x1F<<11);`  
这行代码用于配置ADC的时钟源频率（ADCCLK）。  

- **寄存器背景**：`RCC->CFGR0` 是CH32V003的时钟配置寄存器，其中 **bit11~bit15** 用于设置ADC时钟预分频系数（`ADCPRE`），控制ADCCLK与系统时钟的分频关系。  
- **代码作用**：`0x1F` 是5位全1掩码（二进制`11111`），`<<11` 使其覆盖bit11~bit15；`&= ~(...)` 表示清除这5位的原有值，将其复位为0。  
- **实际效果**：根据CH32V003手册，`ADCPRE` 为0时，ADCCLK = 系统时钟 / 2。结合项目配置（系统时钟为48MHz，来自HSE和PLL），最终 **ADCCLK = 24MHz**，确保ADC工作在稳定的时钟频率下。  


#### （2）`ADC1->SAMPTR2 |= 7<<(3*7);`  
这行代码用于设置ADC通道7的采样时间（采样保持时间）。  

- **寄存器背景**：`ADC1->SAMPTR2` 是ADC采样时间寄存器，每个ADC通道占用3个bit（用于配置采样周期），通道n的bit位置为 `3*n`。  
- **代码作用**：  
  - 通道7对应的bit位置为 `3*7=21`（bit21~bit23）；  
  - `7<<21` 表示将值7写入这3个bit；  
  - 根据手册，值7对应的采样时间为 **241个ADCCLK周期**（最长采样时间，用于提高采样精度，补偿CH32V003 10位ADC的低分辨率问题）。  


### 2. ADC处理时间与Timer定时器时间的关系  
Timer定时器（TIM1）的核心作用是**触发ADC周期性采样**，其时间间隔需与ADC的处理时间（采样+转换）匹配，确保每次采样能完整完成。  


#### （1）Timer定时器的时间间隔（触发周期）  
定时器配置为向上计数模式，由 `PSC`（预分频器）和 `ATRLR`（自动重装载值）决定溢出频率（即ADC触发频率）：  
- 定时器时钟频率 = 系统时钟 / (PSC + 1) = 48MHz / 10 = 4.8MHz；  
- 溢出周期（触发间隔）= (ATRLR + 1) / 定时器时钟频率 = 81 / 4.8MHz ≈ 16.875μs；  
- 这意味着定时器每约16.875μs触发一次ADC采样。  


#### （2）ADC的处理时间（采样+转换）  
ADC的总处理时间包括采样时间和转换时间：  
- 采样时间：241个ADCCLK周期（ADCCLK=24MHz），即 241 / 24MHz ≈ 10.04μs；  
- 转换时间：10位ADC的转换需要固定的13个ADCCLK周期（手册规定），即 13 / 24MHz ≈ 0.54μs；  
- 总处理时间 ≈ 10.04μs + 0.54μs ≈ 10.58μs。  


#### （3）时间关系总结  
定时器触发间隔（≈16.875μs）**大于** ADC总处理时间（≈10.58μs），确保每次定时器触发时，上一次ADC采样已完成，避免采样冲突。这种设计保证了ADC能以固定频率（由定时器决定）稳定采集数据，为后续语音处理（如FFT、梅尔滤波）提供时间均匀的输入。